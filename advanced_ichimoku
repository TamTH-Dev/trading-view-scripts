// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© tamth_

//@version=5
indicator(title='Advanced Ichimoku', shorttitle='Advanced Ichimoku', overlay=true)


// Ichimoku
var color blue_color = color.new(#4577ED, 0)
var color purple_color = color.new(#7859BC, 0)
var color yellow_color = color.new(#FCEF72, 0)
var color orange_color = color.new(#F2AB47, 0)
var color cyan_color = color.new(#60C3D7, 0)
var color green_color = color.new(#52A895, 0)
var color red_color = color.new(#DA4F7A, 0)
var color green_color_opaque = color.new(#52A895, 90)
var color red_color_opaque = color.new(#DA4F7A, 90)

var string tenkan_sen_txt = 'Tenkan-sen'
var string kijun_sen_txt = 'Kijun-sen'
var string short_knife_txt = 'Short knife'
var string long_knife_txt = 'Long knife'
var string chikou_span_txt = 'Chikou-span'
var string senkou_span_a_txt = 'Senkou-span A'
var string senkou_span_b_txt = 'Senkou-span B'
var string kumo_cloud_txt = 'Kumo cloud'

int tenkan_sen_input = input.int(9, minval=1, title=tenkan_sen_txt)
int kijun_sen_input = input.int(17, minval=1, title=kijun_sen_txt)
int short_knife_input = input.int(65, minval=1, title=short_knife_txt)
int long_knife_input = input.int(129, minval=1, title=long_knife_txt)
int senkou_span_b_input = input.int(26, minval=1, title=senkou_span_b_txt)


method get_avg(int periods) => math.avg(ta.lowest(periods), ta.highest(periods))

float tenkan_sen = get_avg(tenkan_sen_input)
float kijun_sen = get_avg(kijun_sen_input)
float senkou_span_a = math.avg(tenkan_sen, kijun_sen)
float senkou_span_b = get_avg(senkou_span_b_input)
float short_knife = get_avg(short_knife_input)
float long_knife = get_avg(long_knife_input)

plot(close, offset=-25, color=cyan_color, title=chikou_span_txt, linewidth=1)
senkou_plot_a = plot(senkou_span_a, offset=25, color=green_color, linewidth=1, title=senkou_span_a_txt)
senkou_plot_b = plot(senkou_span_b, offset=25, color=red_color, linewidth=1, title=senkou_span_b_txt)
fill(senkou_plot_a, senkou_plot_b, color=senkou_span_a > senkou_span_b ? green_color_opaque : red_color_opaque, title=kumo_cloud_txt)
plot(long_knife, color=orange_color, title=long_knife_txt, linewidth=2)
plot(short_knife, color=yellow_color, title=short_knife_txt, linewidth=2)
plot(kijun_sen, color=purple_color, title=kijun_sen_txt, linewidth=1)
plot(tenkan_sen, color=blue_color, title=tenkan_sen_txt, linewidth=1)


method get_future_point(int periods, int idx) => math.avg(ta.highest(periods - idx), ta.lowest(periods - idx))
method get_future_point_1(int periods) => get_future_point(periods, 1)
method get_future_point_2(int periods) => get_future_point(periods, 2)
method get_future_point_3(int periods) => get_future_point(periods, 3)
method get_future_point_4(int periods) => get_future_point(periods, 4)
method get_future_point_5(int periods) => get_future_point(periods, 5)
method get_future_point_6(int periods) => get_future_point(periods, 6)
method get_future_point_7(int periods) => get_future_point(periods, 7)
method get_future_point_8(int periods) => get_future_point(periods, 8)
method get_future_point_9(int periods) => get_future_point(periods, 9)
method get_future_point_10(int periods) => get_future_point(periods, 10)
method get_future_point_11(int periods) => get_future_point(periods, 11)
method get_future_point_12(int periods) => get_future_point(periods, 12)
method get_future_point_13(int periods) => get_future_point(periods, 13)
method get_future_point_14(int periods) => get_future_point(periods, 14)
method get_future_point_15(int periods) => get_future_point(periods, 15)
method get_future_point_16(int periods) => get_future_point(periods, 16)
method get_future_point_17(int periods) => get_future_point(periods, 17)
method get_future_point_18(int periods) => get_future_point(periods, 18)
method get_future_point_19(int periods) => get_future_point(periods, 19)
method get_future_point_20(int periods) => get_future_point(periods, 20)
method get_future_point_21(int periods) => get_future_point(periods, 21)
method get_future_point_22(int periods) => get_future_point(periods, 22)
method get_future_point_23(int periods) => get_future_point(periods, 23)
method get_future_point_24(int periods) => get_future_point(periods, 24)
method get_future_point_25(int periods) => get_future_point(periods, 25)
method get_future_point_26(int periods) => get_future_point(periods, 26)

long_knife_future_point_1 = get_future_point_1(long_knife_input)
long_knife_future_point_2 = get_future_point_2(long_knife_input)
long_knife_future_point_3 = get_future_point_3(long_knife_input)
long_knife_future_point_4 = get_future_point_4(long_knife_input)
long_knife_future_point_5 = get_future_point_5(long_knife_input)
long_knife_future_point_6 = get_future_point_6(long_knife_input)
long_knife_future_point_7 = get_future_point_7(long_knife_input)
long_knife_future_point_8 = get_future_point_8(long_knife_input)
long_knife_future_point_9 = get_future_point_9(long_knife_input)
long_knife_future_point_10 = get_future_point_10(long_knife_input)
long_knife_future_point_11 = get_future_point_11(long_knife_input)
long_knife_future_point_12 = get_future_point_12(long_knife_input)
long_knife_future_point_13 = get_future_point_13(long_knife_input)
long_knife_future_point_14 = get_future_point_14(long_knife_input)
long_knife_future_point_15 = get_future_point_15(long_knife_input)
plot(long_knife_future_point_1, color=orange_color, linewidth=1, offset=1, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_2, color=orange_color, linewidth=1, offset=2, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_3, color=orange_color, linewidth=1, offset=3, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_4, color=orange_color, linewidth=1, offset=4, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_5, color=orange_color, linewidth=1, offset=5, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_6, color=orange_color, linewidth=1, offset=6, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_7, color=orange_color, linewidth=1, offset=7, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_8, color=orange_color, linewidth=1, offset=8, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_9, color=orange_color, linewidth=1, offset=9, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_10, color=orange_color, linewidth=1, offset=10, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_11, color=orange_color, linewidth=1, offset=11, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_12, color=orange_color, linewidth=1, offset=12, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_13, color=orange_color, linewidth=1, offset=13, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_14, color=orange_color, linewidth=1, offset=14, show_last=1, style=plot.style_circles, display = display.pane)
plot(long_knife_future_point_15, color=orange_color, linewidth=1, offset=15, show_last=1, style=plot.style_circles, display = display.pane)

short_knife_future_point_1 = get_future_point_1(short_knife_input)
short_knife_future_point_2 = get_future_point_2(short_knife_input)
short_knife_future_point_3 = get_future_point_3(short_knife_input)
short_knife_future_point_4 = get_future_point_4(short_knife_input)
short_knife_future_point_5 = get_future_point_5(short_knife_input)
short_knife_future_point_6 = get_future_point_6(short_knife_input)
short_knife_future_point_7 = get_future_point_7(short_knife_input)
short_knife_future_point_8 = get_future_point_8(short_knife_input)
short_knife_future_point_9 = get_future_point_9(short_knife_input)
short_knife_future_point_10 = get_future_point_10(short_knife_input)
short_knife_future_point_11 = get_future_point_11(short_knife_input)
short_knife_future_point_12 = get_future_point_12(short_knife_input)
short_knife_future_point_13 = get_future_point_13(short_knife_input)
short_knife_future_point_14 = get_future_point_14(short_knife_input)
short_knife_future_point_15 = get_future_point_15(short_knife_input)
short_knife_future_point_16 = get_future_point_16(short_knife_input)
plot(short_knife_future_point_1, color=yellow_color, linewidth=1, offset=1, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_2, color=yellow_color, linewidth=1, offset=2, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_3, color=yellow_color, linewidth=1, offset=3, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_4, color=yellow_color, linewidth=1, offset=4, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_5, color=yellow_color, linewidth=1, offset=5, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_6, color=yellow_color, linewidth=1, offset=6, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_7, color=yellow_color, linewidth=1, offset=7, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_8, color=yellow_color, linewidth=1, offset=8, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_9, color=yellow_color, linewidth=1, offset=9, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_10, color=yellow_color, linewidth=1, offset=10, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_11, color=yellow_color, linewidth=1, offset=11, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_12, color=yellow_color, linewidth=1, offset=12, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_13, color=yellow_color, linewidth=1, offset=13, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_14, color=yellow_color, linewidth=1, offset=14, show_last=1, style=plot.style_circles, display = display.pane)
plot(short_knife_future_point_15, color=yellow_color, linewidth=1, offset=15, show_last=1, style=plot.style_circles, display = display.pane)

kijun_sen_future_point_1 = get_future_point_1(kijun_sen_input)
kijun_sen_future_point_2 = get_future_point_2(kijun_sen_input)
kijun_sen_future_point_3 = get_future_point_3(kijun_sen_input)
kijun_sen_future_point_4 = get_future_point_4(kijun_sen_input)
kijun_sen_future_point_5 = get_future_point_5(kijun_sen_input)
kijun_sen_future_point_6 = get_future_point_6(kijun_sen_input)
kijun_sen_future_point_7 = get_future_point_7(kijun_sen_input)
kijun_sen_future_point_8 = get_future_point_8(kijun_sen_input)
kijun_sen_future_point_9 = get_future_point_9(kijun_sen_input)
kijun_sen_future_point_10 = get_future_point_10(kijun_sen_input)
kijun_sen_future_point_11 = get_future_point_11(kijun_sen_input)
kijun_sen_future_point_12 = get_future_point_12(kijun_sen_input)
kijun_sen_future_point_13 = get_future_point_13(kijun_sen_input)
kijun_sen_future_point_14 = get_future_point_14(kijun_sen_input)
kijun_sen_future_point_15 = get_future_point_15(kijun_sen_input)
kijun_sen_future_point_16 = get_future_point_16(kijun_sen_input)
plot(kijun_sen_future_point_1, color=purple_color, linewidth=1, offset=1, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_2, color=purple_color, linewidth=1, offset=2, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_3, color=purple_color, linewidth=1, offset=3, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_4, color=purple_color, linewidth=1, offset=4, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_5, color=purple_color, linewidth=1, offset=5, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_6, color=purple_color, linewidth=1, offset=6, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_7, color=purple_color, linewidth=1, offset=7, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_8, color=purple_color, linewidth=1, offset=8, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_9, color=purple_color, linewidth=1, offset=9, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_10, color=purple_color, linewidth=1, offset=10, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_11, color=purple_color, linewidth=1, offset=11, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_12, color=purple_color, linewidth=1, offset=12, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_13, color=purple_color, linewidth=1, offset=13, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_14, color=purple_color, linewidth=1, offset=14, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_15, color=purple_color, linewidth=1, offset=15, show_last=1, style=plot.style_circles, display = display.pane)
plot(kijun_sen_future_point_16, color=purple_color, linewidth=1, offset=16, show_last=1, style=plot.style_circles, display = display.pane)
    
tenkan_sen_future_point_1 = get_future_point_1(tenkan_sen_input)
tenkan_sen_future_point_2 = get_future_point_2(tenkan_sen_input)
tenkan_sen_future_point_3 = get_future_point_3(tenkan_sen_input)
tenkan_sen_future_point_4 = get_future_point_4(tenkan_sen_input)
tenkan_sen_future_point_5 = get_future_point_5(tenkan_sen_input)
tenkan_sen_future_point_6 = get_future_point_6(tenkan_sen_input)
tenkan_sen_future_point_7 = get_future_point_7(tenkan_sen_input)
tenkan_sen_future_point_8 = get_future_point_8(tenkan_sen_input)
plot(tenkan_sen_future_point_1, color=blue_color, linewidth=1, offset=1, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_2, color=blue_color, linewidth=1, offset=2, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_3, color=blue_color, linewidth=1, offset=3, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_4, color=blue_color, linewidth=1, offset=4, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_5, color=blue_color, linewidth=1, offset=5, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_6, color=blue_color, linewidth=1, offset=6, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_7, color=blue_color, linewidth=1, offset=7, show_last=1, style=plot.style_circles, display = display.pane)
plot(tenkan_sen_future_point_8, color=blue_color, linewidth=1, offset=8, show_last=1, style=plot.style_circles, display = display.pane)





// Williams Fractals
int fractals_periods = input.int(title="Williams Fractals Periods", defval=4, minval=2)

// Up Fractals
bool up_flag_down_frontier = true
bool up_flag_up_frontier_0 = true
bool up_flag_up_frontier_2 = true
bool up_flag_up_frontier_3 = true
bool up_flag_up_frontier_4 = true

for idx = 1 to fractals_periods
    up_flag_down_frontier := up_flag_down_frontier and (high[fractals_periods-idx] < high[fractals_periods])
    up_flag_up_frontier_0 := up_flag_up_frontier_0 and (high[fractals_periods+idx] < high[fractals_periods])
    up_flag_up_frontier_2 := up_flag_up_frontier_2 and (high[fractals_periods+1] <= high[fractals_periods] and high[fractals_periods+idx + 1] < high[fractals_periods])
    up_flag_up_frontier_3 := up_flag_up_frontier_3 and (high[fractals_periods+1] <= high[fractals_periods] and high[fractals_periods+2] <= high[fractals_periods] and high[fractals_periods+idx + 2] < high[fractals_periods])
    up_flag_up_frontier_3 := up_flag_up_frontier_3 and (high[fractals_periods+1] <= high[fractals_periods] and high[fractals_periods+2] <= high[fractals_periods] and high[fractals_periods+3] <= high[fractals_periods] and high[fractals_periods+idx + 3] < high[fractals_periods])
    up_flag_up_frontier_4 := up_flag_up_frontier_4 and (high[fractals_periods+1] <= high[fractals_periods] and high[fractals_periods+2] <= high[fractals_periods] and high[fractals_periods+3] <= high[fractals_periods] and high[fractals_periods+4] <= high[fractals_periods] and high[fractals_periods+idx + 4] < high[fractals_periods])

flag_up_frontier = up_flag_up_frontier_0 or up_flag_up_frontier_2 or up_flag_up_frontier_3 or up_flag_up_frontier_3 or up_flag_up_frontier_4
up_fractal = up_flag_down_frontier and flag_up_frontier

// Down Fractals
bool down_flag_down_frontier = true
bool down_flag_up_frontier_0 = true
bool down_flag_up_frontier_1 = true
bool down_flag_up_frontier_2 = true
bool down_flag_up_frontier_3 = true
bool down_flag_up_frontier_4 = true

for idx = 1 to fractals_periods
    down_flag_down_frontier := down_flag_down_frontier and (low[fractals_periods-idx] > low[fractals_periods])
    down_flag_up_frontier_0 := down_flag_up_frontier_0 and (low[fractals_periods+idx] > low[fractals_periods])
    down_flag_up_frontier_1 := down_flag_up_frontier_1 and (low[fractals_periods+1] >= low[fractals_periods] and low[fractals_periods+idx + 1] > low[fractals_periods])
    down_flag_up_frontier_2 := down_flag_up_frontier_2 and (low[fractals_periods+1] >= low[fractals_periods] and low[fractals_periods+2] >= low[fractals_periods] and low[fractals_periods+idx + 2] > low[fractals_periods])
    down_flag_up_frontier_3 := down_flag_up_frontier_3 and (low[fractals_periods+1] >= low[fractals_periods] and low[fractals_periods+2] >= low[fractals_periods] and low[fractals_periods+3] >= low[fractals_periods] and low[fractals_periods+idx + 3] > low[fractals_periods])
    down_flag_up_frontier_4 := down_flag_up_frontier_4 and (low[fractals_periods+1] >= low[fractals_periods] and low[fractals_periods+2] >= low[fractals_periods] and low[fractals_periods+3] >= low[fractals_periods] and low[fractals_periods+4] >= low[fractals_periods] and low[fractals_periods+idx + 4] > low[fractals_periods])

flag_down_frontier = down_flag_up_frontier_0 or down_flag_up_frontier_1 or down_flag_up_frontier_2 or down_flag_up_frontier_3 or down_flag_up_frontier_4
down_fractal = down_flag_down_frontier and flag_down_frontier

plotshape(down_fractal, style=shape.arrowdown, location=location.belowbar, offset=-fractals_periods, color=red_color, size = size.small, display = display.pane)
plotshape(up_fractal, style=shape.arrowup, location=location.abovebar, offset=-fractals_periods, color=green_color, size = size.small, display = display.pane)
